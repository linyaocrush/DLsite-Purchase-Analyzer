# DLsite 購入分析ツール

📈 ユーザー行動に基づくDLsite購入記録の深度分析ツール、可視化チャート、インタラクティブなポップアップ、スマートなデータエクスポートをサポート  
  - DLsite.jsのコードをブラウザコンソールにコピーしてお使いください

---

## 🚀 核心アップデートポイント

- **全新可視化システム**：Chart.jsの動的チャートを統合
- **強化されたインタラクション体験**：ネイティブポップアップを完全にカスタマイズしたモーダルウィンドウで置換
- **スマートなエラーハンドリング**：リアルタイムエラーログ記録と自動リトライメカニズム
- **データ比較分析機能の追加**：指定された時間枠内の購入数と支出を多角的に比較  
  *(バージョン履歴v2.2を参照)*
- **チャートダウンロード機能の追加**：各チャートウィンドウ内にダウンロードボタンが追加され、PNG形式の画像として直接保存できます  
  *(バージョン履歴v2.2を参照)*

---

## 🌟 機能特性

### 🖥️ インタラクションシステム
- ダイナミックポップアップシステム（選択/確認/入力のサポート）
- ドラッグ可能、リサイズ可能なチャートウィンドウ  
  *(注：新しい結果ウィンドウが既存のコンソール出力を置換し、すべての統計データとチャートが独立したウィンドウに表示されます)*
- GSAPアニメーショントランジション効果
- リアルタイム進行状況バーのフィードバック（コンソールとページの両方で表示をサポート）

### 📊 データ分析
- **四次元チャートシステム**：
  - タイプ/制作グループ統計図（棒グラフ ↔ 円グラフの双方向切り替えをサポート）
  - 日別購入トレンド折れ線図
  - 累積消費金額曲線  
    *(チャートをクリックして詳細な作品情報と当日の総額を確認できます)*
- **データ比較分析機能**：  
  新しい比較モジュールは、ユーザーが2つの時間枠を選択し、以下の方面をそれぞれ統計することができます：
  - 異なるタイプの作品の好みの比較
  - 異なる制作グループの好みの比較
  - 制作グループ全体の比較（購入数と消費金額）
  - 制作グループの作品タイプの比較  
  比較結果は、統一された比較チャートコンテナに組み合わせた棒グラフの形で表示されます。
- スマートフィルターシステム（最小作品数で次要データをフィルター）
- 為替換算システム（リアルタイム為替の変更をサポート）

### 🛡️ 拡張機能
- 自動ページ検出とスマートジャンプ
- 下架作品独立マークシステム
- データサンドボックスモード（統計スピードを300%向上）
- クラッシュリカバリメカニズム（グローバルコマンド`window.reloadData`を使用してリカバリ）

### 📦 出力システム
- 多形式エクスポートサポート（MDプレビュー、CSV、コンソールテーブル）
- モバイルデバイスの表示に適応
- エラーログトレース機能
- **チャートダウンロード機能**：各チャートウィンドウの「保存」ボタンをクリックして、現在のチャートをPNG画像としてエクスポートできます

---

## 🛠️ 使用ガイド

### 環境準備
```javascript
// 最新ブラウザの要件
Chrome 89+ / Firefox 86+ / Edge 91+
```

### クイックスタート
1. [DLsite購入記録ページ](https://www.dlsite.com/maniax/mypage/userbuy)にログイン
2. デベロッパーツールを開く（F12）
3. コンソールパネルに完全なコードを貼り付ける

## 🔄 インタラクションフローの詳細解説

```mermaid
graph TD
    A[スクリプトの開始] --> B{ページ検出}
    B -->|現在のページがDLsiteの場合| C[ウェルカムバナーを表示]
    B -->|DLsiteページでない場合| D[ジャンププロンプトを表示]
    D --> E{ユーザーの選択}
    E -->|ジャンプを確認| F[購入記録ページにリダイレクト]
    E -->|操作をキャンセル| G[スクリプトの実行を終了]
    
    C --> H[モード選択ダイアログ]
    H --> I{モードを選択}
    I -->|クイックモード| J[詳細を取得をスキップ]
    I -->|詳細モード| K[作品タイプの選択を開始]
    
    K --> L[タイプフィルタを表示]
    L --> M{具体的なタイプを選択}
    M -->|0（すべて）を選択| N[デフォルトのURLを維持]
    M -->|特定のタイプを選択| O[リクエストパラメータを変更]
    
    J --> P[為替設定ダイアログ]
    K --> P
    P --> Q{為替を変更する必要がある？}
    Q -->|はい| R[数字入力ダイアログを表示]
    Q -->|いいえ| S[デフォルト為替0.04858を使用]
    
    R --> T[入力検証]
    T -->|有効な数字| U[為替値を更新]
    T -->|無効な入力| V[エラーを表示しデフォルトを復元]
    
    U --> W[データ取得を開始]
    S --> W
    W --> X[二重進行状況のフィードバックを表示]
    X --> Y[[リアルタイム進行状況バー]]
    X --> Z[コンソールにページ単位で表示]
    
    W --> AA[データクリーニングステージ]
    AA --> AB{下架作品が存在する？}
    AB -->|はい| AC[下架リストを独立でマーク]
    AB -->|いいえ| AD[統計ステージに進む]
    
    AD --> AE[フィルタしきい値を設定]
    AE --> AF[最小作品数を入力]
    AF --> AG[データをフィルタ]
    
    AG --> AH[チャート設定ダイアログ]
    AH --> AI{チャートを表示する？}
    AI -->|はい| AJ[Chart.jsを非同期で読み込む]
    AI -->|いいえ| AK[チャートレンダリングをスキップ]
    
    AJ --> AL[四チャートコンテナを生成]
    AL --> AM[ユーザーインタラクションイベント]
    AM --> AN[チャートタイプを切り替える]
    AM --> AO[ウィンドウをドラッグ/リサイズ]
    
    AK --> AP[結果エクスポートダイアログ]
    AH --> AP
    AP --> AQ{ファイルを保存する？}
    AQ -->|はい| AR[形式を選択]
    AQ -->|いいえ| AS[コンソールに完全な出力を表示]
    
    AR --> AT[[MDプレビューウィンドウ]]
    AR --> AU[CSVを直接ダウンロード]
    AT --> AV[インタラクティブプレビュー]
    AV --> AW[ダウンロードを確認]
    
    AS --> AX[テーブルを美しく印刷]
    AX --> AY[タイムライングループを展開]
    AY --> AZ[コンソールで折りたたんで表示]
    
    AZ --> BA[エラーデテクションモジュール]
    BA --> BB{エラーログが存在する？}
    BB -->|はい| BC[エラー項目を強調表示]
    BB -->|いいえ| BD[成功アイコンを表示]
    
    BD --> BE[著者情報を表示]
    BE --> BF[プロジェクトアドレスを表示]
    BF --> BG[スクリプトの実行が終了]
    
    %% 新規データ比較分析フロー
    BG --> BH[データ比較分析モジュールを開始]
    BH --> BI[ユーザーが時間枠と比較する方面を選択]
    BI --> BJ[比較チャート（組み合わせ棒グラフ）を生成]
```

### キーインタラクションノードの説明

#### 1. ダイナミックポップアップシステム
- **三层ポップアップアーキテクチャ**：
  - 基礎層：半透明オーバーレイ（`.modal-overlay`）
  - コンテンツ層：アダプティブコンテナ（`.modal-container`）
  - 操作層：ボタングループ（`.btn`クラスター）
- **スマートフォーカス**：最後のポップアップは常に最高のz-indexを取得

#### 2. チャートインタラクション
- **インスタントリドロー**：切り替えボタンをクリックして古いChartインスタンスを破壊し、再構築する
- **メモリ機能**：各チャートのタイプ状態（棒グラフ/円グラフ）はグローバル変数に独立して保存される
- **レスポンシブデザイン**：
  ```javascript
  // ウィンドウリサイズイベントリスナー
  container.style.resize = "both";
  // キャンバスサイズを自動調整
  canvas.style.width = "100%";
  canvas.style.height = "calc(100% - 30px)";
  ```

#### 3. データ取得フロー
```mermaid
graph LR
    A[開始ページ] --> B[DOM解析]
    B --> C{詳細モード？}
    C -->|はい| D[詳細を取得を開始]
    C -->|いいえ| E[詳細をスキップ]
    D --> F[並列リクエスト管理]
    F --> G[最大並列制御]
    G --> H[エラー再試行メカニズム]
    H --> I[データアグリゲーション]
    E --> I
```

#### 4. 例外処理パス
```mermaid
graph TD
    A[ネットワークリクエスト] --> B{ステータスコード200？}
    B -->|いいえ| C[エラーログを記録]
    C --> D[リトライカウンター+1]
    D --> E{リトライ<3？}
    E -->|はい| F[1秒遅延後再試行]
    E -->|いいえ| G[失敗リクエストをマーク]
    B -->|はい| H[データ処理を続ける]
```

#### 5. ファイルエクスポートフロー
```mermaid
graph LR
    A[エクスポートを開始] --> B{形式を選択}
    B --> C[MDプレビュー]
    B --> D[CSVを直接出力]
    B --> E[組み合わせエクスポート]
    C --> F[Blobを生成]
    D --> F
    E --> F
    F --> G[仮想ダウンロード]
    G --> H[メモリを解放]
```

---

## ⚙️ パラメータ設定

### モード選択
| オプション   | 機能説明                                   |
| ------ | ------------------------------------------ |
| クイックモード | 基本的な消費データのみを統計（詳細を取得をスキップ）          |
| 詳細モード | 完全なラベル分析 + 主タイプ統計                  |

### 高度な設定
```markdown
1. 為替校正：デフォルトは1 CNY = 0.04858 JPY、小数点以下6桁までをサポート
2. フィルタしきい値：数字Nを入力すると、作品数 < Nの分類を自動的にフィルタ
3. チャート設定：各チャートは独立して表示タイプ（棒グラフ/円グラフ）を記憶
```

---

## 📊 出力例

### コンソール出力
```markdown
✦ DLsite購入履歴統計 ✦
購入作品数：189 部
累積消費金額：¥82,450 JPY（≈¥3,987.51 CNY）

★ 各種類統計 ★
同人音声    | ██████████ 58
成人向けゲーム  | ███████ 37
漫画コレクション    | █████ 25

★ チャートシステム ★
[動的ウィンドウ1] タイプ分布（棒グラフ/円グラフ切り替え）
[動的ウィンドウ2] 制作グループランキング（棒グラフ/円グラフ切り替え）
[動的ウィンドウ3] 消費トレンド折れ線図
[動的ウィンドウ4] 累積消費金額曲線
```

### ファイルエクスポート
```markdown
# DLsite購入履歴調査報告

## 消費軌跡分析
![累積消費図](data:image/png;base64,...)

## 異常記録
| 日付       | 作品名         | 状態   |
|------------|------------------|--------|
| 2025/03/05 | [下架済み]作品X    | 404    |
```

---

## ⚠️ 注意事項

### パフォーマンス最適化
```markdown
1. PC端で実行することをお勧め（モバイル端は自動的に表示に適応するが機能が制限される）
2. 作品数が100以上の場合、クイックモードをオンにすることをお勧め
3. `window.clearLogs`を使用してメモリをクリア
```

### エラーハンドリング
```markdown
ネットワークエラーが発生した場合：
1. 自動的に3回リトライ
2. エラーログはerrorLogs配列に保存
3. reloadDataコマンドで復元をサポート
```

---

## 🏗️ 技術アーキテクチャ詳細

### システムレイヤーアーキテクチャ
```mermaid
graph TB
    subgraph UI層
        A[可視化コンポーネント] --> A1[Chart.jsチャート]
        A --> A2[GSAPアニメーション]
        A --> A3[カスタムモーダルシステム]
        A --> A4[ドラッグ可能なコンテナ]
    end
    
    subgraph データ層
        B[コアロジック] --> B1[Fetch API]
        B --> B2[DOMパーサ]
        B --> B3[並列コントローラ]
        B --> B4[データクリーナ]
    end
    
    subgraph 持続層
        C[データ出力] --> C1[Blobストレージ]
        C --> C2[FileSaver.js]
        C --> C3[Console.table]
    end
    
    subgraph ツール層
        D[補助モジュール] --> D1[進行状況マネージャ]
        D --> D2[エラーコレクタ]
        D --> D3[為替コンバータ]
        D --> D4[メモリクリーナ]
    end
```

### キーテクノロジースタック

#### コア依存ライブラリ
| ライブラリ/技術         | バージョン    | 用途               | キー実装関数                         |
| --------------- | ------- | ------------------ | ------------------------------------ |
| **Chart.js**    | 4.4.0   | データ可視化         | `drawGenreChart()`、`drawMakerChart()` など |
| **GSAP**        | 3.12.0  | アニメーションエンジン           | `animateModalIn()`、`fadeOut()`        |
| **DOMParser**   | ネイティブ  | DOM解析             | `processPage()` データ抽出               |
| **FileSaver**   | 2.0.5   | ファイルエクスポート           | `exportCSV()` ダウンロード実装                |

#### ネイティブ技術応用
```markdown
1. **WebアニメーションAPI**  
   - 進行状況バーの動的効果を実現
   - コンソール進行アニメーション（ASCII文字）

2. **CSS Grid/Flex**  
   - レスポンシブチャートコンテナレイアウト
   - モーダルウィンドウのアダプティブレイアウト

3. **ResizeObserver**  
   - チャートウィンドウのリサイズイベントを监听
   - キャンバスサイズを動的に調整

4. **Proxy API**  
   - グローバル状態管理（エラーログ/チャートタイプ状態）
```

### キーモジュール実装

#### 1. 並列コントロールシステム
```javascript
// 最大並列数制御
const MAX_CONCURRENT = 5;
let activePromises = 0;

async function controlledFetch(url) {
  while (activePromises >= MAX_CONCURRENT) {
    await new Promise(resolve => setTimeout(resolve, 500));
  }
  activePromises++;
  try {
    return await fetch(url);
  } finally {
    activePromises--;
  }
}
```

#### 2. メモリ管理メカニズム
```javascript
// スマートクリア戦略
const memoryWatcher = {
  threshold: 0.8, // メモリ使用しきい値
  cleanup() {
    if (performance.memory.usedJSHeapSize / 
        performance.memory.jsHeapSizeLimit > this.threshold) {
      this.forceCleanup();
    }
  },
  forceCleanup() {
    genreChartObj?.destroy();
    makerChartObj?.destroy();
    URL.revokeObjectURL(blobCache);
  }
};

// 60秒ごとに検出
setInterval(() => memoryWatcher.cleanup(), 60000);
```

#### 3. アニメーションシステムアーキテクチャ
```mermaid
graph LR
    A[アニメーションを開始] --> B{GSAPが利用可能？}
    B -->|はい| C[GSAP Timelineを使用]
    B -->|いいえ| D[ネイティブWebアニメーション]
    C --> E[ベジエ曲線イージング]
    D --> F[CSSトランジション]
    E --> G[複合アニメーション]
    F --> G
    G --> H[コールバックキュー]
```

### パフォーマンス最適化戦略

#### データ取得の最適化
```markdown
1. **ページ事前ロード**  
   - Promise.allSettled()を使用して並列リクエスト
   - ネットワーク遅延に応じて動的に並列数を調整

2. **DOMキャッシュ**  
   - 既に解析されたドキュメントオブジェクトを再利用
   - セレクタ結果キャッシュプール

3. **増分レンダリング**  
   - 50msごとに10個のノードを処理してDOMノードをバッチ処理
```

#### チャートの最適化
```javascript
// Canvasレンダリングの最適化
Chart.defaults.animation = false; // デフォルトアニメーションを無効化
Chart.defaults.datasets.bar.barThickness = 25; // 固定バー幅
Chart.defaults.elements.point.radius = 3; // データポイントを最適化

// スマートリドローストラテジー
function debouncedRedraw() {
  let isRendering = false;
  return () => {
    if (!isRendering) {
      requestAnimationFrame(() => {
        genreChartObj?.update();
        makerChartObj?.update();
        isRendering = false;
      });
      isRendering = true;
    }
  };
}
```

### セキュリティメカニズム
```markdown
1. **サンドボックスモード**  
   - Proxyを使用してグローバル変数をカプセル化
   - メモリ操作権限を制限

2. **入力検証**  
   ```javascript
   // 為替入力検証
   const validateExchangeRate = (input) => {
     return /^0\.0\d{1,5}$/.test(input) && 
            parseFloat(input) > 0;
   };
   ```

### CORS処理
   - 動的にno-corsモードを追加
   - 失敗リクエストは指数バックオフアルゴリズムで自動リトライ


> 📌 **アーキテクチャ設計原則**  
> 1. モジュール化設計 - 各機能モジュールの最大コード行数 ≤ 200  
> 2. メモリセキュリティ - オブジェクト破棄後にGCを自動的にトリガー  
> 3. グレープアップ - コア機能はサードパーティーライブラリに依存しない  
> 4. モバイルファースト - すべてのコンポーネントはモバイルタッチに適応

---

## 📌 バージョン履歴

### v2.2 (2025/03/08)
- データ比較分析機能を追加（一定期間の購入作品数と支出を比較）
- チャートダウンロード機能を追加

### v2.1 (2025/03/07)
- 結果ウィンドウを追加し、ユーザーがコンソール出力を確認する必要をなくしました

### v2.0 (2025/03/03)
- 四次元チャートシステムを追加
- インタラクションシステムを再構築（alert/promptをすべてカスタムモーダルに置換）
- ウィンドウドラッグ&リサイズ機能を追加
- モバイルデバイスのアダプティブ性を最適化
- サンドボックスモードメモリ管理を実装
- GSAPアニメーションエンジンサポートを追加
- エラーハンドリングシステムをアップグレード

### v1.2 (2025/02/24)
- CSVエクスポート機能を強化
- コンソール表示ロジックを最適化

---

## 📄 ライセンス
MITライセンス | 商業用途は禁止  
完全な声明はコードのヘッダーコメントを参照

---

> 🌐 プロジェクトアドレス：https://github.com/linyaocrush/DLsite-Purchase-Analyzer  
> 📧 問題フィードバック：コントロールコンソールのエラーのスクリーンショットを添付してIssueを作成してください
